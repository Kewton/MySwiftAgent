# Phase 3 作業計画: ワークフロー実行時エラー対応

**作成日**: 2025-10-26
**ブランチ**: feature/issue/110
**前提条件**: Phase 2完了（モデル切り替えによるYAML構文エラー解決）

---

## 📊 Phase 2 の成果サマリー

### ✅ 達成した成果

| 指標 | 目標 | 実績 | 達成状況 |
|------|------|------|---------|
| **YAML構文エラー** | 0件 | 0件 | ✅ 完全達成 |
| **複数行文字列記法** | 正しい記法使用 | `|-` 使用 | ✅ 完全達成 |
| **APIレスポンス成功率** | 100% | 100% (6/6) | ✅ 完全達成 |
| **ワークフロー実行成功率** | 80%以上 | 0% (0/6) | ❌ 未達成 |

### 📈 モデル切り替えの効果

**使用モデル**: 不明（ユーザーが切り替え）

**処理時間の変化**:
- 前回（Gemini 2.0 Flash）: 平均 16.6秒/タスク
- 今回（切り替え後）: 平均 109.4秒/タスク
- **増加率**: 6.6倍

**品質の変化**:
- YAML構文エラー: 100% → 0% ✅
- 複数行文字列記法: 誤 → 正 ✅
- 実行時エラー: なし → HTTP 500発生 ⚠️

### 🔍 新たに発見された課題

全6タスクで以下のエラーが発生:
```
"Workflow execution failed (HTTP 500)"
"Workflow produced no results"
```

**推定原因**:
1. エージェント名の不正確な参照 (例: `geminiAgent` が存在しない)
2. 入力/出力スキーマの不整合
3. GraphAI実行環境の制約
4. データフローの論理エラー

---

## 🎯 Phase 3 の目的

### 主目的

**最低1タスクでワークフロー実行成功を達成する**

### 具体的目標

1. 実行時エラーの根本原因を特定
2. YAML修正またはプロンプト改善により解決
3. GraphAIでのE2E実行を成功させる
4. 修正パターンを文書化し、残り5タスクに適用可能にする

---

## 📋 Phase 3 タスク分解

### Task 3.1: エラー原因の特定 (2-3時間)

#### 3.1.1 Task 1のYAML詳細分析 (1時間)

**実施内容**:
- `task_001_keyword_analysis.yaml` を読み込み
- 使用されているエージェント名をリストアップ
- GraphAI実装で実際に存在するエージェントと照合

**期待される発見**:
- エージェント名の誤り（例: `geminiAgent` → `openAIAgent`）
- スキーマ定義の不整合
- データ参照パスのエラー

#### 3.1.2 GraphAIでの手動実行テスト (1-2時間)

**実施内容**:
- GraphAI APIを使用してTask 1のYAMLを実行
- エラーログを詳細に収集
- 各ノードの実行結果を確認

**必要な環境**:
- GraphAI サーバー起動
- サンプル入力データの準備

**検証項目**:
- [ ] sourceAgentが正常動作するか
- [ ] geminiAgentが存在するか（存在しない場合は代替エージェント）
- [ ] jsonParserAgentが正常動作するか
- [ ] copyAgentが正常動作するか
- [ ] データフロー（`:source.keyword` など）が正しいか

---

### Task 3.2: 修正方針の決定 (30分)

#### オプションA: YAML手動修正 (推奨 - 高速)

**メリット**:
- ✅ 即座に実行成功を達成可能
- ✅ 修正パターンを明確に把握できる

**デメリット**:
- ❌ 自動生成品質は向上しない
- ❌ 残り5タスクは別途修正が必要

**所要時間**: 1-2時間

#### オプションB: プロンプト改善 (推奨 - 長期品質向上)

**メリット**:
- ✅ 自動生成品質が向上
- ✅ 他のタスクにも適用可能
- ✅ 他のシナリオ（1-3）にも効果

**デメリット**:
- ❌ 時間がかかる（3-4時間）
- ❌ 複数回の試行錯誤が必要

**所要時間**: 3-4時間

#### オプションC: ハイブリッド (推奨)

1. まず手動修正で1タスク成功させる（1-2時間）
2. 修正パターンからプロンプト改善案を作成（1時間）
3. 改善プロンプトで再生成テスト（1時間）

**所要時間**: 3-4時間

---

### Task 3.3: 修正の実施 (2-3時間)

#### オプションA実施の場合

**Step 1: Task 1のYAML手動修正** (30分)

修正内容例:
```yaml
# Before
generate_podcast_plan:
  agent: geminiAgent  # ← 存在しない可能性

# After
generate_podcast_plan:
  agent: openAIAgent  # ← 実際に存在するエージェント
  inputs:
    model: "gpt-4"
    prompt: |
      ...
```

**Step 2: GraphAIで実行テスト** (30分)
- 修正したYAMLを実行
- 成功するまで修正を繰り返し

**Step 3: 修正パターンの文書化** (30分)
- どのエージェント名を使用すべきか
- どのスキーマが必要か
- データフローのベストプラクティス

#### オプションB実施の場合

**Step 1: Few-shot Learning プロンプト作成** (1時間)

修正したYAMLを「理想的な例」として、プロンプトに追加:

```markdown
## 正しいYAML例

以下は、実際にGraphAIで動作する正しいワークフローYAMLの例です。
この例を参考に、正確なエージェント名とスキーマを使用してください。

```yaml
version: 0.5
nodes:
  source:
    agent: sourceAgent

  generate_content:
    agent: openAIAgent  # ← 正しいエージェント名
    inputs:
      model: "gpt-4"
      prompt: "..."
```

**Step 2: プロンプト改善の実装** (1時間)

`expertAgent/aiagent/langgraph/workflowGeneratorAgents/prompts/workflow_generation.py` を修正:
- エージェント名の明示的な指定
- スキーマ定義の厳格化
- Few-shot exampleの追加

**Step 3: 再生成と検証** (1-2時間)
- Task 1を再生成
- GraphAIで実行テスト
- 成功率を測定

---

### Task 3.4: 結果評価とドキュメント作成 (1-2時間)

#### 3.4.1 評価レポート作成

**評価項目**:
| 項目 | 目標 | 実績 | 判定 |
|------|------|------|------|
| ワークフロー実行成功率 | ≥16.7% (1/6) | XX% | ✅/❌ |
| GraphAI E2E成功 | 1回以上 | X回 | ✅/❌ |
| 修正パターン文書化 | 完了 | XX | ✅/❌ |

#### 3.4.2 成果物

**必須ドキュメント**:
1. `phase-3-execution-error-analysis.md`: エラー原因分析
2. `phase-3-yaml-corrections.md`: 修正内容詳細
3. `phase-3-e2e-test-report.md`: 実行テスト結果
4. `phase-3-completion-report.md`: Phase 3完了報告

**成果物（YAML）**:
- 修正済みYAMLファイル（最低1個）
- 成功した実行ログ
- サンプル入出力データ

---

## ⚠️ リスクと対策

### リスク1: GraphAI環境が利用不可

**リスク**: GraphAI サーバーが起動していない、またはAPIアクセス不可

**対策**:
- 環境確認を最初に実施
- 利用不可の場合は、YAML静的解析のみ実施
- 実行テストは別タスクに延期

### リスク2: エージェント名が全て不正確

**リスク**: 使用すべきエージェント名が不明

**対策**:
- GraphAIのエージェント一覧を取得
- ドキュメント `GRAPHAI_WORKFLOW_GENERATION_RULES.md` を参照
- サンプルYAMLから正しいエージェント名を学習

### リスク3: 修正しても実行失敗が続く

**リスク**: YAMLロジック自体に根本的な問題

**対策**:
- シンプルなワークフローから段階的にテスト
- 最小構成（sourceAgent + copyAgent のみ）で動作確認
- 複雑なロジックは後回し

---

## 📅 スケジュール

| Task | 内容 | 予定工数 | 優先度 |
|------|------|---------|-------|
| Task 3.1 | エラー原因の特定 | 2-3時間 | 🔴 最優先 |
| Task 3.2 | 修正方針の決定 | 30分 | 🔴 最優先 |
| Task 3.3 | 修正の実施 | 2-3時間 | 🟡 高 |
| Task 3.4 | 結果評価・ドキュメント | 1-2時間 | 🟡 高 |

**総予定工数**: 5.5-8.5時間

---

## ✅ 成功基準

### 必須要件

- [ ] **最低1タスクでGraphAI実行成功**
- [ ] 実行時エラーの根本原因を特定・文書化
- [ ] 修正パターンを明確化

### 推奨要件

- [ ] プロンプト改善により自動生成品質向上
- [ ] 複数タスク（2個以上）で実行成功
- [ ] E2Eテストの自動化スクリプト作成

### オプション要件

- [ ] 全6タスクで実行成功
- [ ] パフォーマンス最適化（処理時間短縮）
- [ ] エラーハンドリングの強化

---

## 📝 Phase 2 との相違点

| 項目 | Phase 2 | Phase 3 |
|------|---------|---------|
| **焦点** | YAML構文エラー解決 | ワークフロー実行成功 |
| **主な作業** | モデル切り替え、プロンプト修正 | YAML修正、GraphAI実行テスト |
| **成功基準** | YAML構文エラーゼロ | 最低1タスクで実行成功 |
| **所要時間** | 約11分（生成） | 5.5-8.5時間（修正・テスト） |

---

## 🔄 次のステップ（Phase 4以降）

### Phase 4: 残り5タスクの対応 (別issue推奨)

- Phase 3で確立した修正パターンを適用
- 全6タスクで実行成功を目指す

### Phase 5: 自動化とCI/CD統合 (別issue推奨)

- ワークフロー生成からE2Eテストまで自動化
- 品質メトリクスの継続的測定

### Phase 6: 他シナリオへの展開 (別issue推奨)

- シナリオ1-3でも同様にワークフロー生成
- 成功率・品質の横断比較

---

## 📚 参考ドキュメント

**必須参照**:
- [ ] [GraphAI ワークフロー生成ルール](../../../../graphAiServer/docs/GRAPHAI_WORKFLOW_GENERATION_RULES.md)
- [ ] [アーキテクチャ概要](../../../../docs/design/architecture-overview.md)

**推奨参照**:
- [ ] `phase-2-completion-report.md`: Phase 2の成果と課題
- [ ] `workflow-generation-work-plan.md`: 元の作業計画

---

**作成者**: Claude Code
**バージョン**: 1.0
**最終更新**: 2025-10-26
